# -*- coding: utf-8 -*-
"""Генерация отчёта КТ-1 в формате Word."""
from docx import Document
from docx.shared import Pt, Cm, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE
from docx.oxml.ns import qn
from docx.oxml import OxmlElement

def set_cell_shading(cell, color):
    shading = OxmlElement('w:shd')
    shading.set(qn('w:fill'), color)
    cell._tc.get_or_add_tcPr().append(shading)

def set_run_font(run, bold=False):
    """Применить Times New Roman 12 pt ко всем run."""
    run.font.name = 'Times New Roman'
    run._element.rPr.rFonts.set(qn('w:eastAsia'), 'Times New Roman')
    run.font.size = Pt(12)
    run.font.bold = bold

def create_report():
    doc = Document()
    
    # Настройка стилей
    style = doc.styles['Normal']
    font = style.font
    font.name = 'Times New Roman'
    font.size = Pt(12)
    style.paragraph_format.line_spacing = 1.5  # 1.5 интервал
    style.paragraph_format.first_line_indent = Cm(1.25)
    style.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.JUSTIFY
    
    # Поля страницы: левое 25 мм, правое 10 мм, верхнее и нижнее 20 мм
    for section in doc.sections:
        section.left_margin = Cm(2.5)
        section.right_margin = Cm(1)
        section.top_margin = Cm(2)
        section.bottom_margin = Cm(2)
        
        # Нумерация страниц снизу по центру (вставка — Вставка > Номер страницы > Внизу страницы > Простой номер 2)
    
    # ========== ТИТУЛЬНЫЙ ЛИСТ ==========
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('Федеральное государственное бюджетное образовательное учреждение\nвысшего образования')
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    doc.add_paragraph()
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('<Название университета>')
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    doc.add_paragraph()
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('Факультет прикладной математики и информатики')
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    for _ in range(3):
        doc.add_paragraph()
    
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('Отчёт по контрольной точке №1 (КТ-1)')
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    doc.add_paragraph()
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('по программному проекту')
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    for _ in range(2):
        doc.add_paragraph()
    
    p = doc.add_paragraph()
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    run = p.add_run('DogPaw: мобильное приложение для владельцев собак')
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(14)
    
    for _ in range(3):
        doc.add_paragraph()
    
    p = doc.add_paragraph('Направление подготовки: <код и название>')
    p.paragraph_format.first_line_indent = Cm(0)
    p = doc.add_paragraph('Студент: <Фамилия И.О.>')
    p.paragraph_format.first_line_indent = Cm(0)
    p = doc.add_paragraph('Группа: <номер группы>')
    p.paragraph_format.first_line_indent = Cm(0)
    p = doc.add_paragraph('Научный руководитель: <Фамилия И.О., учёная степень>')
    p.paragraph_format.first_line_indent = Cm(0)
    
    doc.add_paragraph()
    p = doc.add_paragraph('<Город> — 2025')
    p.paragraph_format.first_line_indent = Cm(0)
    
    doc.add_page_break()
    
    # ========== СОДЕРЖАНИЕ ==========
    p = doc.add_paragraph('СОДЕРЖАНИЕ')
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    p.paragraph_format.first_line_indent = Cm(0)
    run = p.runs[0]
    run.bold = True
    run.font.name = 'Times New Roman'
    run.font.size = Pt(12)
    
    toc_items = [
        'АННОТАЦИЯ',
        '1. Введение',
        '2. Обзор существующих решений и аналогов',
        '3. Описание программного проекта',
        '4. Эксперименты и оценка качества',
        '5. Заключение',
        'Список литературы',
    ]
    for item in toc_items:
        p = doc.add_paragraph(item)
        p.paragraph_format.first_line_indent = Cm(0)
    
    doc.add_page_break()
    
    # ========== АННОТАЦИЯ ==========
    p = doc.add_paragraph('АННОТАЦИЯ')
    p.alignment = WD_ALIGN_PARAGRAPH.CENTER
    p.paragraph_format.first_line_indent = Cm(0)
    run = p.runs[0]
    run.bold = True
    
    abstract = """В работе представлены результаты разработки мобильного приложения DogPaw, предназначенного для владельцев собак. Реализована кросс-платформенная система для iOS и Android с серверным компонентом, объединяющим функции дневника питомца, трекера прогулок, интерактивной карты полезных мест и социальной сети для собаководов. Ключевая реализованная особенность — умная карта с отображением геолокации пользователей и статусами готовности к общению («Ищем компанию», «На тренировке», «Не беспокоить»). Архитектура системы построена по клиент-серверной схеме: мобильное приложение на React Native (Expo) и REST API на языке Go с использованием SQLite и ORM GORM. В отчёте описаны постановка задачи, требования к системе, реализованная архитектура, пользовательские сценарии, этапы реализации и объёмные характеристики проекта. Выполнена базовая проверка работоспособности компонентов; полноценные эксперименты по нагрузочному тестированию и оценке UX планируются на следующих этапах. Достигнутые результаты: работоспособный прототип приложения с шестью основными экранами, 22 API-эндпоинта, более 1500 строк исходного кода."""
    
    p = doc.add_paragraph(abstract)
    p.paragraph_format.first_line_indent = Cm(1.25)
    
    p = doc.add_paragraph()
    p.paragraph_format.first_line_indent = Cm(0)
    run = p.add_run('Ключевые слова: ')
    run.bold = True
    p.add_run('мобильное приложение, владельцы собак, React Native, REST API, Golang, кросс-платформенная разработка, геолокация, социальная сеть, QR-код, фитнес-трекер.')
    
    doc.add_page_break()
    
    # Функция для добавления параграфа с отступом
    def add_para(text, indent=True):
        p = doc.add_paragraph(text)
        if indent:
            p.paragraph_format.first_line_indent = Cm(1.25)
        else:
            p.paragraph_format.first_line_indent = Cm(0)
        return p
    
    def add_heading(text, level=1):
        p = doc.add_paragraph()
        p.paragraph_format.first_line_indent = Cm(0)
        run = p.add_run(text)
        run.bold = True
        run.font.size = Pt(12)
        run.font.name = 'Times New Roman'
        return p
    
    # ========== 1. ВВЕДЕНИЕ ==========
    add_heading('1. Введение')
    
    add_heading('1.1 Область и актуальность', level=2)
    add_para('Рост числа домашних животных в городских условиях сопровождается повышением запроса на цифровые решения, облегчающие уход за питомцами и организацию их выгула [1]. Владельцы собак используют несколько разрозненных приложений: дневники здоровья, карты ветеринарных клиник, социальные сети для обмена опытом. Отсутствие единого инструмента, объединяющего перечисленные функции с акцентом на безопасность питомца и упрощение знакомства между собаководами, определяет актуальность разработки специализированного приложения.')
    add_para('Особую значимость имеет функция быстрой идентификации потерявшейся собаки посредством QR-кода на ошейнике, а также возможность визуализации локаций других владельцев в реальном времени для организации совместных прогулок.')
    
    add_heading('1.2 Формулировка задачи', level=2)
    add_para('Требовалось спроектировать и реализовать программную систему, включающую мобильное приложение для платформ iOS и Android и серверную часть, обеспечивающую хранение данных и бизнес-логику. Система должна поддерживать: ведение карточек питомцев с уникальными QR-кодами; трекинг прогулок с расчётом расстояния и калорий; калькулятор норм кормления; карту полезных мест (ветклиники, парки, зоомагазины, кафе); умную карту с отображением геопозиций пользователей и их статусов; социальные функции (друзья, лента); базу знаний по уходу за собаками.')
    
    add_heading('1.3 Цель и задачи проекта', level=2)
    p = doc.add_paragraph()
    p.paragraph_format.first_line_indent = Cm(1.25)
    run = p.add_run('Цель проекта ')
    run.bold = True
    p.add_run('— разработка кросс-платформенного мобильного приложения DogPaw, интегрирующего функции дневника питомца, трекера активности, карты мест и социальной сети для владельцев собак.')
    
    p = doc.add_paragraph()
    p.paragraph_format.first_line_indent = Cm(1.25)
    run = p.add_run('Задачи проекта:')
    run.bold = True
    
    tasks = [
        'провести анализ существующих аналогов и обосновать необходимость собственной разработки;',
        'сформулировать функциональные и нефункциональные требования к системе;',
        'спроектировать архитектуру клиент-серверной системы;',
        'реализовать серверный компонент (REST API) на языке Go;',
        'реализовать мобильное приложение на React Native (Expo) для iOS и Android;',
        'реализовать интеграцию с геолокацией и картографическими сервисами;',
        'провести базовую проверку работоспособности;',
        'подготовить документацию и инструкции по развёртыванию.',
    ]
    for t in tasks:
        p = doc.add_paragraph(t, style='List Bullet')
        p.paragraph_format.left_indent = Cm(1.5)
        p.paragraph_format.first_line_indent = Cm(-0.5)
    
    add_heading('1.4 Достигнутые результаты', level=2)
    add_para('В рамках контрольной точки достигнут рабочий прототип приложения с полным циклом основных пользовательских сценариев: создание и просмотр карточки питомца с генерацией QR-кода, трекинг прогулок с отображением статистики, калькулятор норм кормления, карта полезных мест и умная карта с переключением режимов, экран социальных функций (друзья, лента), база знаний с фильтрацией по категориям. Серверная часть развёртывается локально и предоставляет 22 REST API-эндпоинта. Реализован скрипт наполнения демонстрационными данными. Мобильное приложение собирается через Expo и запускается на эмуляторах iOS и Android. Подготовлена документация по запуску и структуре репозитория.')
    
    doc.add_page_break()
    
    # ========== 2. ОБЗОР ==========
    add_heading('2. Обзор существующих решений и аналогов')
    add_para('На рынке представлены приложения, покрывающие отдельные аспекты функциональности DogPaw. Приложения-дневники (Pet Descriptions, Puppr) позволяют вести записи о здоровье и активности питомца, но не предлагают QR-идентификацию для экстренных случаев. Картографические сервисы (Google Maps, 2GIS) содержат точки интереса для владельцев животных, однако не специализированы на категориях ветклиник, грумеров и собачьих площадок, а также не поддерживают социальный контекст [2].')
    add_para('Социальные сети и мессенджеры используются для общения собаководов, но не интегрированы с геолокацией в реальном времени и не предоставляют структурированных данных о местах выгула. Фитнес-трекеры и приложения для бега (Strava, Nike Run Club) позволяют записывать маршруты, однако не учитывают специфику прогулок с собаками — расчёт калорий животного и привязку к карточке питомца.')
    add_para('Коммерческие приложения с частичным пересечением функциональности (BringFido для поиска мест, дружественных к собакам) ориентированы на зарубежный рынок и не предлагают комплексного решения для российских пользователей. Отсутствие единого продукта, сочетающего QR-идентификацию для безопасности, трекинг прогулок, карту мест с отзывами и умную карту с геолокацией пользователей, обосновывает необходимость разработки DogPaw как специализированного решения.')
    
    doc.add_page_break()
    
    # ========== 3. ОПИСАНИЕ ПРОЕКТА ==========
    add_heading('3. Описание программного проекта')
    
    add_heading('3.1 Постановка задачи и требования к системе', level=2)
    add_para('К системе предъявлены следующие функциональные требования, реализация которых выполнена в рамках КТ-1:')
    
    reqs = [
        'управление карточками питомцев: создание, редактирование, хранение данных (кличка, порода, возраст, вес, фотографии, медицинские сведения);',
        'генерация и отображение уникального QR-кода для каждого питомца; возможность сканирования QR-кода для доступа к контактной информации владельца;',
        'трекинг прогулок: интерфейс для записи прогулки, отображение статистики (расстояние, длительность, калории) и истории;',
        'калькулятор норм кормления с учётом веса, возраста и уровня активности;',
        'карта полезных мест с категориями: ветклиники, зоомагазины, грумеры, парки, кафе;',
        'умная карта: отображение геопозиций пользователей с указанием статуса («Ищем компанию», «На тренировке», «Не беспокоить»);',
        'социальные функции: интерфейс списка друзей, лента постов, кнопка сканирования QR;',
        'база знаний: структурированные статьи по категориям (воспитание, уход, здоровье, питание).',
    ]
    for r in reqs:
        p = doc.add_paragraph(r, style='List Bullet')
        p.paragraph_format.left_indent = Cm(1.5)
        p.paragraph_format.first_line_indent = Cm(-0.5)
    
    add_para('Реализованы требования к поддержке платформ iOS и Android через кросс-платформенную сборку Expo; обеспечена работа API в формате JSON; настроен CORS для взаимодействия с мобильным клиентом. Аутентификация пользователей планируется к внедрению на последующих этапах.')
    
    add_heading('3.2 Реализованная архитектура системы', level=2)
    add_para('Система реализована в виде клиент-серверной архитектуры. Клиентский компонент — мобильное приложение на базе React Native 0.76 и Expo SDK 52 [3], обеспечивающее единую кодовую базу для iOS и Android. Используются библиотеки: React Navigation для навигации (нижние вкладки и стеки), React Native Maps для картографии, react-native-qrcode-svg для генерации QR-кодов, expo-location и expo-camera для геолокации и сканирования.')
    add_para('Серверный компонент — REST API на языке Go 1.21 с использованием фреймворка Gin [4] для маршрутизации и обработки HTTP-запросов. Хранение данных организовано с помощью SQLite через ORM GORM [5]. Модели данных включают сущности: User, Pet, Walk, Place, Review, UserLocation, Friendship, FeedPost, Article. Автомиграции GORM создают схемы таблиц при запуске.')
    add_para('Взаимодействие между клиентом и сервером осуществляется по протоколу HTTP в формате JSON. Клиент отправляет запросы к эндпоинтам /api/v1/<ресурс>; сервер возвращает данные в формате JSON. Реализованы эндпоинты для получения и обновления локации пользователя (GET /map/users, PUT /map/me) для поддержки умной карты.')
    add_para('Основные сущности и их поля: User (id, email, name, avatar); Pet (id, owner_id, name, breed, age, weight, photos, allergies, vaccinations, vet_contacts, qr_code_data); Walk (id, pet_id, distance, duration, calories, route, started_at, ended_at); Place (id, name, address, category, latitude, longitude, rating); UserLocation (user_id, pet_id, latitude, longitude, status, last_updated). Категории мест: vet, pet_shop, groomer, park, cafe. Статусы на умной карте: looking_for_company, training, do_not_disturb.')
    
    add_heading('3.3 Реализованные пользовательские сценарии', level=2)
    add_para('Сценарий 1. Пользователь открывает экран «Питомец», просматривает карточку с данными собаки. Система отображает QR-код, сгенерированный по полю qr_code_data. Пользователь может распечатать и закрепить код на ошейнике.')
    add_para('Сценарий 2. Нашедший собаку сканирует QR-код. API GET /pets/qr/:qr возвращает данные питомца с контактами владельца и экстренной информацией (аллергии, ветврач).')
    add_para('Сценарий 3. Пользователь открывает экран «Прогулки», нажимает «Начать прогулку». Интерфейс отображает счётчики расстояния, времени и калорий. По завершении данные сохраняются; история прогулок отображается в списке.')
    add_para('Сценарий 4. Пользователь открывает экран «Карта», переключается между режимами «Места» и «Умная карта». В режиме «Места» отображаются маркеры ветклиник, парков, зоомагазинов. В режиме «Умная карта» — маркеры пользователей с подписями статусов.')
    add_para('Сценарий 5. Пользователь открывает экран «Друзья», видит список друзей и кнопку «Отсканировать QR-код на ошейнике» для быстрого добавления контакта.')
    add_para('Сценарий 6. Пользователь открывает экран «Энциклопедия», выбирает категорию (Воспитание, Уход, Здоровье, Питание) и просматривает список статей.')
    
    add_heading('3.4 План реализации и выполненная декомпозиция', level=2)
    add_para('Этап 1. Настроена структура репозитория (клиент в корне, сервер в backend/), конфигурация Expo, TypeScript, Go-модулей.')
    add_para('Этап 2. Реализован серверный API: модели данных (9 сущностей), миграции GORM, 8 модулей обработчиков (users, pets, walks, places, map, friends, feed, articles), 22 эндпоинта, CORS middleware, скрипт seed для демонстрационных данных.')
    add_para('Этап 3. Реализовано мобильное приложение: навигация (5 вкладок, стек для экрана питомца и калькулятора), экраны PetProfileScreen (QR-код, анкета, медицинские данные), WalkTrackerScreen (старт/стоп прогулки, история), FeedingCalculatorScreen (форма расчёта нормы корма, напоминания).')
    add_para('Этап 4. Реализован экран MapScreen с React Native Maps: переключение режимов «Места» / «Умная карта», отображение маркеров мест и пользователей, легенда статусов.')
    add_para('Этап 5. Реализован SocialScreen: список друзей, лента постов, кнопка сканирования QR.')
    add_para('Этап 6. Реализован EncyclopediaScreen: поиск, фильтрация по категориям, список статей. Подготовлена документация README, REPOSITORY.')
    
    add_heading('3.5 Объёмные характеристики проекта', level=2)
    add_para('Измерены следующие характеристики реализованной системы.')
    add_para('Исходный код. Суммарный объём: более 1500 строк. Клиентская часть (TypeScript/TSX): около 860 строк в 12 файлах. Серверная часть (Go): около 680 строк в 15 файлах.')
    add_para('API. Количество эндпоинтов: 22. Группы: users (2), pets (4), walks (2), places (4), map (2), friends (2), feed (2), articles (2), health (1).')
    add_para('Интерфейс. Количество экранов: 6 (Питомец, Прогулки, Карта, Друзья, Энциклопедия; калькулятор кормления доступен из экрана Питомца). Навигация: 5 вкладок в нижней панели, 2 экрана в стеке.')
    add_para('База данных. Используется SQLite; файл dogowner.db создаётся при первом запуске. Скрипт seed наполняет 1 пользователя, 1 питомца, 3 места, 3 статьи.')
    
    doc.add_page_break()
    
    # ========== 4. ЭКСПЕРИМЕНТЫ ==========
    add_heading('4. Эксперименты и оценка качества')
    add_para('Выполнена базовая проверка работоспособности компонентов системы.')
    add_para('Проверка API. Сервер запускается командой go run . и принимает запросы на порту 8080. Эндпоинт GET /health возвращает статус 200. Эндпоинты GET /api/v1/pets/1, GET /api/v1/places возвращают данные после выполнения скрипта seed. Формат ответов соответствует ожидаемой структуре JSON.')
    add_para('Проверка мобильного приложения. Приложение собирается через npm start и expo start. Запуск в режиме разработки успешен; навигация между вкладками функционирует; экраны отображают корректные данные.')
    add_para('Рекомендуемые эксперименты. На следующих этапах планируется провести: нагрузочное тестирование API (Apache JMeter или k6) с симуляцией 50–100 пользователей; замер времени отклика типовых запросов (среднее, p95, p99); оценку потребления памяти и батареи мобильным приложением при трекинге прогулки; опрос целевой аудитории по шкале SUS [6] для оценки удобства интерфейса; сравнение набора функций с аналогами по чек-листу.')
    
    doc.add_page_break()
    
    # ========== 5. ЗАКЛЮЧЕНИЕ ==========
    add_heading('5. Заключение')
    add_para('В отчёте представлены результаты разработки мобильного приложения DogPaw для владельцев собак в рамках контрольной точки №1. Реализована кросс-платформенная система, объединяющая функции дневника питомца с QR-кодом, трекера прогулок, калькулятора кормления, карты полезных мест и умной карты с геолокацией пользователей, социальных функций и базы знаний. Архитектура построена на клиент-серверной схеме: React Native (Expo) и Go (Gin, GORM, SQLite). Достигнуты рабочий прототип с шестью экранами, 22 REST API-эндпоинтами и более 1500 строками кода. Выполнена базовая проверка работоспособности.')
    add_para('Направления дальнейшей работы: внедрение аутентификации и авторизации (JWT); реализация полноценного трекинга маршрута с записью координат; интеграция сканера QR через expo-camera; загрузка реальных данных мест из внешних API; проведение нагрузочного тестирования и оценки UX; подготовка сборок для публикации в App Store и Google Play.')
    
    doc.add_page_break()
    
    # ========== СПИСОК ЛИТЕРАТУРЫ ==========
    add_heading('Список литературы')
    
    refs = [
        '[1] Pet industry statistics and trends. Statista. URL: https://www.statista.com/topics/2849/pet-industry (дата обращения: 03.02.2025).',
        '[2] Google Maps Platform. URL: https://developers.google.com/maps (дата обращения: 03.02.2025).',
        '[3] Expo Documentation. URL: https://docs.expo.dev (дата обращения: 03.02.2025).',
        '[4] Gin Web Framework. URL: https://gin-gonic.com (дата обращения: 03.02.2025).',
        '[5] GORM. The fantastic ORM library for Golang. URL: https://gorm.io (дата обращения: 03.02.2025).',
        '[6] Brooke J. SUS: A Quick and Dirty Usability Scale // Usability Evaluation in Industry. Taylor & Francis, 1996. P. 189–194.',
        '[7] Fielding R. T. Architectural Styles and the Design of Network-based Software Architectures. Doctoral dissertation. UC Irvine, 2000.',
        '[8] Sommerville I. Software Engineering. 10th ed. Pearson, 2015.',
        '[9] React Native. URL: https://reactnative.dev (дата обращения: 03.02.2025).',
    ]
    for ref in refs:
        p = doc.add_paragraph(ref)
        p.paragraph_format.first_line_indent = Cm(0)
        p.paragraph_format.left_indent = Cm(1.25)
        p.paragraph_format.hanging_indent = Cm(-1.25)
    
    # Сохранение
    output_path = r'C:\Users\idial\projects\dog-owner-app\docs\КТ1_отчет.docx'
    doc.save(output_path)
    print('Сохранено:', output_path)
    print('Добавьте нумерацию: Вставка -> Номер страницы -> Внизу страницы -> Простой номер 2')
    print('Для титульника без номера: двойной клик по колонтитулу -> включите "Особый колонтитул для первой страницы"')

if __name__ == '__main__':
    create_report()
